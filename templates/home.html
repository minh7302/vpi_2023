<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="/static/script.js" defer></script>
  <script src="https://kit.fontawesome.com/abdc579eb6.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.5/pagination.min.js"></script>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <header class="header">
    <div class="header-left">
      <button class="menu-icon-btn" data-menu-icon-btn>
      <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" focusable="false" class="menu-icon"><g ><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></g></svg>
    </button>
    <a href="#default" class="logo" style="font-size: 25px; font-family:'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;">Viện dầu khí</a>
    </div>
    
    <div class="header-right">
      <a href="#contact" style="font-size: 20px;">Contact</a>
      <a href="#about" style="font-size: 20px;">About</a>
      
      <div class="notification">
        <i class="fa-regular fa-bell fa-2x" style="cursor: pointer;"></i>
        <span class="badge">3</span>
      </div>
      <div class="dropdown" style="position: relative; display: inline-block; cursor: pointer;">
        <div><i class="fa-solid fa-user fa-2x"></i><i class="fa-solid fa-caret-down"></i></div>
        <div class="dropdown-content">
          <a href="http://127.0.0.1:8000/logout">Logout</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container" style="display: flex;">
    <aside class="sidebar" data-sidebar>
      <div class="top-sidebar" style="display: flex; flex-direction: column; align-items: center;">
        <a href="#" class="channel-logo"><img src="/static/VPI_logo.png" alt="Channel Logo"></a>
        <!-- <div class="hidden-sidebar" style="text-align: center;width: 100%;">Danh sách giếng khoan</div> -->
        <!-- <div class="hidden-sidebar channel-name" style="color: rgb(96, 96, 96);font-size: .75rem;">Web Dev Simplified</div> -->
      </div>
      <div class="middle-sidebar">
        <ul class="sidebar-list">
          <li class="sidebar-list-item active">
            <a href="http://127.0.0.1:8000" class="sidebar-link">
              <svg class="sidebar-icon" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" focusable="false" ><g ><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"></path></g></svg>
              <div class="hidden-sidebar">Dashboard</div>
            </a>
          </li>
          <li class="sidebar-list-item">
            <a onclick="import_tab()" class="sidebar-link">
              <!--mở 1 tab mới để import file-->
              <script>
                function import_tab() {
                  window.open("http://127.0.0.1:8000/import_table");
                }
              </script>
              <?xml version="1.0" encoding="utf-8"?>
              <svg class="sidebar-icon" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" focusable="false"><line id="secondary" x1="12" y1="16" x2="12" y2="3" style="fill: none; stroke: rgb(44, 169, 188); stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;"></line><polyline id="secondary-2" data-name="secondary" points="16 7 12 3 8 7" style="fill: none; stroke: rgb(44, 169, 188); stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;"></polyline><path id="primary" d="M20,16v4a1.08,1.08,0,0,1-1.14,1H5.14A1.08,1.08,0,0,1,4,20V16" style="fill: none; stroke: rgb(0, 0, 0); stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;"></path></svg>
              <div class="hidden-sidebar">Upload</div>
            </a>
          </li>
          <li class="sidebar-list-item">
            <a href="#" class="sidebar-link well_id" >
              <svg class="sidebar-icon" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" focusable="false"><g><path d="M2 5.5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-13zm9 0H4v3h7v-3zm2 0v3h7v-3h-7zm7 5h-7v3h7v-3zm0 5h-7v3h7v-3zm-9 3v-3H4v3h7zm-7-5h7v-3H4v3z"/></g></svg>
              <div class="hidden-sidebar">Well Id</div>
            </a>
          </li>
          {% for i in list_tables%}
          <li class="sidebar-list-item">
            <a href="http://127.0.0.1:8000/tables/{{i[0]}}" class="sidebar-link" style="margin-left: 2rem;">
              <div class="hidden-sidebar" style="color: rgb(2,131,198);">{{i[0]}}</div>
            </a>
          </li>
          {%endfor%}
          <!-- <li class="sidebar-list-item">
            <a href="#" class="sidebar-link">
              <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" focusable="false" class="sidebar-icon"><g><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path></g></svg>
              <div class="hidden-sidebar">Comments</div>
            </a>
          </li>
          <li class="sidebar-list-item">
            <a href="#" class="sidebar-link">
              <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" focusable="false" class="sidebar-icon"><g><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"></path></g></svg>
              <div class="hidden-sidebar">Subtitles</div>
            </a>
          </li> -->
        </ul>
      </div>
      <div class="bottom-sidebar">
        <ul class="sidebar-list">
          <li class="sidebar-list-item">
            <a href="#" class="sidebar-link">
              <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" focusable="false" class="sidebar-icon"><g><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></g></svg>
              <div class="hidden-sidebar">Settings</div>
            </a>
          </li>
          <li class="sidebar-list-item">
            <a href="#" class="sidebar-link">
              <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" focusable="false" class="sidebar-icon"><g><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 12h-2v-2h2v2zm0-4h-2V6h2v4z"></path></g></svg>
              <div class="hidden-sidebar">Send Feedback</div>
            </a>
          </li>
        </ul>
      </div>
    </aside>

    <main class="content" style="margin: 1rem; width: 100%; ">
      <div class="content_top" style="display: flex; justify-content: center; background-color: rgb(248,249,250); margin-bottom: 1rem;">
        <div class="t-left" style="display: flex; justify-content: center;flex-direction: column; width: 70%;">
          <div style="display: flex; justify-content: space-around; margin-bottom: 5px;">
            <div style="display: flex;">
              <div style="font-weight: bold;">Nhập tên giếng: </div>
              <input id="name_input" type="text" placeholder="{{well_id}}">
              <button onclick="getTable()">Submit</button>
            </div>
            <!-- {%if keys != null%}
            <div>
              <label for="beauty" style="font-size: 20px;">Show</label>
              <select id="mySelect" onchange="redirectToPage()" name="beauty" style="padding: 3px; ">
                <option value="20">20</option>
                <option value="30" selected>30</option>
                <option value="50">50</option>
              </select>
            </div>
            {%endif%} -->
          </div>
          {%if keys != null%}
          <div id="export" class="checkbox" style="overflow-x: scroll;">
              <div>
                  <div style="display: flex; justify-content: center;">
                    <b style="margin-right: 5px;">Chọn các cột để xuất:</b>
                    <input type="checkbox" onclick="toggle(this);"> All
                  </div>
                  <div style="display: flex; justify-content: center; flex-wrap: wrap;">
                    {% for name in keys %}
                    <input type="checkbox" class="names_selected" value="{{name}}">
                    <label for="names_selected">{{name}}</label>
                    {% endfor %}
                    <button onclick="Redirect()">Export</button>
                  </div>
              </div>
          </div>
          {%endif%}
        </div>
        {%if keys != null%}
          <div class="t-right" style="width: 30%; display: grid; place-items: center;">
            <div>
              <input id="t_start" style="width: 5rem;" type="text" placeholder="Top">
              <input id="b_end" style="width: 5rem;" type="text" placeholder="Base">
              <button onclick="new_pag()">Submit</button>
            </div>
            <div style="display: flex;">
              <button id="show_add_row" class="beauty-button" onclick="showContent()"> Thêm 1 bản ghi</button>
              <!--Ẩn/Hiện thẻ add_row khi click button trên-->
              <script>
                function showContent() {
                  var myElement = document.getElementById('add_row');
                  var myButton = document.getElementById("show_add_row");
                  if (myElement.style.display === "none") {
                    myElement.style.display = "";
                    myButton.innerHTML = 'Huỷ'
                  } else {
                    myElement.style.display = "none";
                    myButton.innerHTML = 'Thêm 1 bản ghi'
                  }
                }
              </script>
              <button id="hide-column-button" class="beauty-button" style="margin-left: 1rem;">Sửa</button>
              <button class="beauty-button" style="margin-left: 1rem;" onclick="deleteTable('{{well_id}}')">Xoá {{well_id}}</button>
              <!--Xoá dữ liệu bảng hiện tại đang truy cập-->
              <script>
                function deleteTable(well_id) {
                  fetch (`http://127.0.0.1:8000/api/delete/cal_curve_value/well_id/${well_id}`, {
                        method: "DELETE",
                  })
                  .then((response) => {
                    if (!response.ok) {
                      throw new Error("Network response was not ok");
                    }
                    return response.json();
                  })
                  .then((data) => {
                    alert("Object deleted successfully!");
                  })
                  .catch((error) => {
                    console.error("There was an error:", error);
                    alert("Failed to delete object");
                  });
                  var table_delete = document.getElementById('table');
                  table_delete.innerHTML = '';
                  alert('{{well_id}} không còn tồn tại');
                }
              </script>
            </div>
          </div>
        {%endif%}
      </div>
      <div id="add_row" style="display: none;">
        <table style="display: grid; place-items: center; margin-bottom: 2rem;">
          <tr>
            {%for i in keys%}
            <td>
              <input id="{{i}}" type="text" placeholder="{{i}}" style="width: 7rem;">
            </td>
            {%endfor%}
          </tr>
          <tr>
            <td><button id="confirm_add" onclick="add_row_funct()">Submit</button></td>
          </tr>
        </table>
        
        <!--Thêm 1 hàng dữ liệu trong bảng cal_curve_value trên databases-->
        <script>
          function add_row_funct() {
            var data = {};
            var keys = ['record_id','curve_id','md','cal_value','well_id','file_id','create_uid','create_time','write_uid','write_time']
            var important = ['md', 'cal_value','file_id','well_id']
            // Kiểm tra các phần tử có tên trong important có trống hay không, nếu có thì data = {}
            keys.forEach(function(key) {
                var value = document.getElementById(key).value;
                if (important.includes(key) && value == '') {
                  data = {}
                  return false;
                }
                if (value !== '') {
                    data[key] = value;
                }
            });
            count = Object.keys(data).length
            if (count < 1) {
              data = {}
              alert('Điền đầy đủ các giá trị md, cal_value, file_id, well_id')
            }
            fetch('http://127.0.0.1:8000/api/add/cal_curve_value', {
              method: 'POST',
              headers: {
                'accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
            })
            document.getElementById('show_add_row').innerHTML = 'Thêm 1 bản ghi';
            document.getElementById('add_row').style.display = 'none';
          }
        </script>
      </div>
      <div style="display: grid; place-items: center;">
        <div class="content_bottom">
          <div id="table" style="display: flex; flex-direction: column-reverse; flex-shrink: 0; overflow-y: auto; width: 200%; margin-right: 2rem;">
            {%if keys != null%}
            <div id="pagination"></div>
            {%endif%}
          </div>
          {%if keys != null%}
          <!-- <div class="visualization">
            <iframe id='dash_html' src="http://127.0.0.1:8050" height="94.5%"></iframe>
          </div> -->
          {%endif%}
        </div>
      </div>
    </main>
  </div>
</body>
</html>

<script>
  // Đây là đoạn mã JavaScript được viết để lấy dữ liệu từ một API và tạo một bảng trong HTML dựa trên dữ liệu đó. 
  // Khi hàm "create_Table" được gọi với một tham số là địa chỉ URL của API, nó sẽ sử dụng phương thức "fetch" để gửi yêu cầu GET đến địa chỉ đó và trả về một đối tượng JSON chứa dữ liệu. 
  // Sau đó, dữ liệu được xử lý và sắp xếp thành một bảng HTML bằng cách sử dụng các thẻ HTML như "table", "thead", "tbody", "tr", "th", và "td".
  function create_Table(url) {
    // Lấy dữ liệu
    fetch(url , {
        method: 'GET',
        headers: {
            'Authorization': 'bearer {{token}}',
            'login_user': '{{token}}'
        }
      }).then(function(response) {
        return response.json();
      })
      .then(function(data) {
        data = data['records']
        var table = document.createElement("table");
        table.setAttribute("id", "myTable");
        // Tạo bảng và các thành phần của bảng
        //tạo tên cột
        var thead = document.createElement("thead");
        table.appendChild(thead);
  
        var headerRow = document.createElement("tr");
        thead.appendChild(headerRow);
        var headers = Object.keys(data[0]);
        for (let i = 0; i < headers.length; i++) {
          var th = document.createElement("th");
          th.textContent = headers[i];
          headerRow.appendChild(th);
        }
        var th = document.createElement("th");
        th.setAttribute("class","hidden")
        th.textContent = "Edit";
        headerRow.appendChild(th);
  
        // nội dung các dòng table
        var tbody = document.createElement("tbody");
        table.appendChild(tbody);
        for (let i = 0; i < data.length; i++) {
          var row = document.createElement("tr");
          tbody.appendChild(row);
          for (var property in data[i]) {
            var cell = document.createElement("td");
            cell.textContent = `${data[i][property]}`;
            row.appendChild(cell);
          }
          var cell = row.insertCell();
          cell.style.width = "8%";
          cell.setAttribute("class", "hide_show hidden")
          var editBtn = document.createElement("button");
          editBtn.innerHTML = "Sửa";
          editBtn.setAttribute("onclick", "editRow(this)");

          var deleteBtn = document.createElement("button");
          deleteBtn.innerHTML = "Xoá";
          deleteBtn.setAttribute("onclick", "deleteRow(this)");
          cell.appendChild(editBtn);
          cell.appendChild(deleteBtn);
        }

        // Thêm bảng vào DOM
        document.querySelector("#table").appendChild(table);
        var hideColumnButton = document.getElementById("hide-column-button");
        var columnToHide = document.querySelectorAll(".hide_show");
        var table = document.getElementById("myTable");
        var lastColumnIndex, column;
        lastColumnIndex = table.rows[0].cells.length;
        column= document.querySelector("th:nth-child(" + lastColumnIndex + ")");
        
        hideColumnButton.addEventListener("click", () => {
          if (columnToHide[0].classList.contains("hidden")) {
            hideColumnButton.innerText = "DONE!";
            columnToHide.forEach((cell) => cell.classList.remove("hidden"));
            column.classList.remove("hidden");
            
          } else {
            columnToHide.forEach((cell) => cell.classList.add("hidden"));
            hideColumnButton.innerText = "EDIT";
            column.classList.add("hidden");
          }
        });

        // tính toán chiều cao của bảng và áp dụng nó cho phần tử khác trong HTML.
          var h_table = document.getElementById('myTable').clientHeight;
          var h_dash = document.getElementById('dash_html');
          h_dash.style.height = `${h_table}`;
      })
      .catch(function(error) {
        console.log(error);
      });
  }  
</script>

<!--tạo ra phân trang cho một bảng dữ liệu và gọi các API tương ứng. 
  Nó sử dụng phương thức fetch để gửi một yêu cầu API đến một địa chỉ cụ thể (được chỉ định trong đoạn mã) để lấy dữ liệu. 
  Sau đó, nó sử dụng các phương thức callback để xử lý dữ liệu trả về và hiển thị phân trang cho bảng dữ liệu. 
  Các giá trị đầu vào của bảng dữ liệu (như độ sâu bắt đầu và kết thúc) được lấy từ các phần tử HTML trong trang web.-->
<script>
  var t_start = document.getElementById('t_start');
  var b_end = document.getElementById('b_end');
  document.getElementById('t_start').addEventListener("keyup", function(event) {
    if (event.keyCode === 13) {
      new_pag();
    }
  });
  document.getElementById('b_end').addEventListener("keyup", function(event) {
    if (event.keyCode === 13) {
      new_pag();
    }
  });
  var new_value_t;
  if(t_start.value == '') new_value_t = 0;
  else new_value_t = t_start.value;
  function new_pag(){
    var start_end = '';
    if (b_end.value != '') {start_end = '&min_md=' + new_value_t + '&max_md=' + b_end.value;}
    else {start_end = '&min_md=' + new_value_t;}
    apiNew_pagination(start_end)
  }
  new_pag() // Lấy String chứa độ sâu bắt đầu và độ sâu kết thúc của bảng

  //thực hiện tạo phân trang và các api tương ứng
  function apiNew_pagination(tail){
    console.log(tail);
    fetch('http://127.0.0.1:8000/api/pivot_table/{{well_id}}?page=1&' + tail, {
        method: 'GET',
        headers: {
            'Authorization': 'bearer {{token}}',
            'login_user': '{{token}}'
        }
      })
    .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        var count = (data['count_rows'])
        var arr = []
        for (let i = 0; i < count; i++) {
          arr.push(i)
        }

        const regex = /\d/;
        if (regex.test(tail) == false) tail = ''
        $('#pagination').pagination({
          dataSource: arr,
          pageSize: Number('{{rowsPerPage}}'),
          showGoInput: true,
          showGoButton: true,
        
          callback: function(data, pagination) {
            var url = 'http://127.0.0.1:8000/api/pivot_table/{{well_id}}?page=' + pagination.pageNumber + tail;
            create_Table(url)
            var myTable = document.getElementById("myTable");
            if (myTable != null) myTable.parentNode.removeChild(myTable);
          }
        })
      })
      .catch(function(error) {
        console.log(error);
      });
  }
</script>

<!--Tự động tích các checkbox còn lại khi nhấn vào checkbox all-->
<script>
  function toggle(source) {
      var checkboxes = document.querySelectorAll('input[type="checkbox"]');
      for (var i = 0; i < checkboxes.length; i++) {
          if (checkboxes[i] != source) checkboxes[i].checked = source.checked;
      }
  }
</script>

<!--Update dòng được chọn-->
<script>
  function editRow(button) {
    var row = button.parentNode.parentNode; // lấy dòng chứa nút "Sửa"
    var cells = row.cells; // lấy tất cả các ô trong dòng
  
    // lấy dữ liệu cũ từ các ô
    var oldData = [];
    for (var i = 0; i < cells.length - 1; i++) {
      oldData.push(cells[i].innerHTML);
    }
  
    // hiển thị form nhập liệu
    var formData = prompt("Nhập dữ liệu mới", oldData.join(","));
    if (formData != null && formData.split(",").length <= oldData.length) {
      // lưu dữ liệu mới vào các ô
      var newData = formData.split(",");
      for (var i = 0; i < newData.length; i++) {
        cells[i].innerHTML = newData[i].trim();
      }
    }


  }
  // Xoá dòng được chọn
  function deleteRow(button) {
    var row = button.parentNode.parentNode; // lấy dòng chứa nút "Xóa"
    var record_id = row.cells[0].innerHTML
    var name_column = row.parentNode.parentNode.rows[0].cells[0].innerHTML

    fetch (`http://127.0.0.1:8000/api/delete/cal_curve_value/${name_column}/${record_id}`, {
          method: "DELETE",
    })
    .then((response) => {
      if (!response.ok) {
        throw new Error("Network response was not ok");
      }
      return response.json();
    })
    .then((data) => {
      alert("Object deleted successfully!");
    })
    .catch((error) => {
      console.error("There was an error:", error);
      alert("Failed to delete object");
    });
    row.parentNode.removeChild(row); // xóa dòng khỏi bảng
  }
  </script>

<!--Export các cột được chọn trong cal_curve_value-->
<script>
  function Redirect() {
      var arr = '';
      var checkedValue = ''; 
      var inputElements = document.getElementsByClassName('names_selected');
      for(var i=0; i<inputElements.length; ++i){
          if(inputElements[i].checked){
              arr += inputElements[i].value + ",";
          }
      }
      arr = arr.slice(0,-1);
      if(arr.length < 1) alert('Please select column')
      else window.location="http://127.0.0.1:8000/api/export/cal_curve_value/" + arr;
  }
</script>

<!--Nhập tên bảng muốn xem và chuyển đến bảng vừa nhập-->
<script>
  var input = document.getElementById('name_input');
  function getTable(){
    window.location="http://127.0.0.1:8000/tables/" + input.value;
  }

  input.addEventListener("keyup", function(event) {
    if (event.keyCode === 13) {
      getTable();
    }
  });
</script>